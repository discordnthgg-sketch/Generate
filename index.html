<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Univers à Mots - Générateur d'Univers Immersifs</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Librairies JS -->
    <script src="https://cdn.jsdelivr.net/npm/colorthief@2.3.2/dist/color-thief.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* Reset et variables */
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --text-primary: #e8e8f0;
            --text-secondary: #b8b8d1;
            --accent-primary: #7c3aed;
            --accent-secondary: #10b981;
            --accent-tertiary: #f59e0b;
            --card-bg: rgba(25, 25, 40, 0.8);
            --border-color: rgba(124, 58, 237, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 12px;
            --transition: all 0.3s ease;
        }
        
        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --card-bg: rgba(255, 255, 255, 0.9);
            --border-color: rgba(124, 58, 237, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            transition: var(--transition);
        }
        
        /* Particules de fond */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        /* Container principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        header {
            padding: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: var(--accent-primary);
            filter: drop-shadow(0 0 8px rgba(124, 58, 237, 0.5));
        }
        
        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #7c3aed, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--accent-primary);
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            transform: rotate(20deg);
            box-shadow: 0 0 12px var(--accent-primary);
        }
        
        /* Hero section */
        .hero {
            text-align: center;
            padding: 60px 0 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        
        .hero p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }
        
        /* Zone de saisie */
        .generator {
            padding: 30px 0;
        }
        
        .prompt-container {
            max-width: 800px;
            margin: 0 auto 40px;
        }
        
        .prompt-input {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            color: var(--text-primary);
            resize: vertical;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .prompt-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }
        
        .prompt-input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .examples {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .example-tag {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .example-tag:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .generate-btn {
            display: block;
            margin: 30px auto;
            padding: 16px 40px;
            background: linear-gradient(90deg, #7c3aed, #10b981);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.6);
        }
        
        .generate-btn:active {
            transform: translateY(-1px);
        }
        
        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-icon {
            margin-right: 10px;
        }
        
        /* Loader */
        .loader {
            display: none;
            text-align: center;
            margin: 40px 0;
        }
        
        .loader.active {
            display: block;
        }
        
        .alchemy-loader {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .alchemy-loader:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--accent-primary);
            border-bottom-color: var(--accent-secondary);
            animation: spin 1.5s linear infinite;
        }
        
        .alchemy-loader:after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-left-color: var(--accent-tertiary);
            border-right-color: var(--accent-tertiary);
            animation: spinReverse 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes spinReverse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-360deg); }
        }
        
        /* Résultats */
        .results {
            display: none;
            padding: 40px 0 80px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .results.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 992px) {
            .results-grid {
                grid-template-columns: 3fr 2fr;
            }
        }
        
        .result-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-primary);
        }
        
        .card-title i {
            font-size: 1.3rem;
        }
        
        /* Image générée */
        .image-container {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            min-height: 300px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .generated-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: var(--radius);
            display: none;
            object-fit: contain;
        }
        
        .generated-image.active {
            display: block;
            animation: fadeIn 0.8s ease;
        }
        
        .placeholder-image {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-direction: column;
            gap: 15px;
        }
        
        .placeholder-image i {
            font-size: 4rem;
            opacity: 0.5;
        }
        
        /* Palette de couleurs */
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-hex {
            font-family: monospace;
            font-size: 0.9rem;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .color-hex:hover {
            background: var(--accent-primary);
            color: white;
        }
        
        /* Carte son */
        .audio-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }
        
        .audio-visualizer canvas {
            width: 100%;
            height: 100%;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .audio-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .audio-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }
        
        .audio-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .audio-info {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .audio-download {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .audio-download:hover {
            background: var(--accent-primary);
            color: white;
        }
        
        /* Carte texte */
        .text-container {
            position: relative;
            padding: 20px;
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            line-height: 1.8;
            background: linear-gradient(to bottom, #f9f3e9, #f5eedf);
            color: #3a2c1a;
            border-radius: var(--radius);
            border: 1px solid #d4b483;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .text-container:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #7c3aed, #10b981);
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .generated-text {
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        
        .generated-text.active {
            opacity: 1;
        }
        
        .text-placeholder {
            color: #8a7a6a;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
        }
        
        /* Actions */
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }
        
        .action-btn {
            padding: 14px 28px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        /* Footer */
        footer {
            padding: 40px 0;
            text-align: center;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        
        .footer-link {
            color: var(--accent-primary);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .footer-link:hover {
            color: var(--accent-secondary);
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: var(--radius);
            margin: 20px 0;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .message.active {
            display: flex;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.15);
            border-left: 4px solid var(--success);
            color: var(--success);
        }
        
        .message.warning {
            background: rgba(245, 158, 11, 0.15);
            border-left: 4px solid var(--warning);
            color: var(--warning);
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid var(--error);
            color: var(--error);
        }
        
        .message.info {
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid #3b82f6;
            color: #3b82f6;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .color-palette {
                justify-content: center;
            }
            
            .audio-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .action-btn {
                justify-content: center;
            }
        }
        
        /* Style pour les images générées par Canvas */
        .canvas-image {
            width: 100%;
            height: auto;
            border-radius: var(--radius);
        }
    </style>
</head>
<body>
    <!-- Canvas pour les particules de fond -->
    <canvas id="particles-canvas"></canvas>
    
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <i class="fas fa-sparkles logo-icon"></i>
                <h1 class="logo-text">Univers à Mots</h1>
            </div>
            <button class="theme-toggle" id="themeToggle" aria-label="Changer de thème">
                <i class="fas fa-moon"></i>
            </button>
        </header>
        
        <!-- Hero Section -->
        <section class="hero">
            <h1>Donnez vie à vos mots</h1>
            <p>Décrivez un univers en quelques mots et recevez son essence sous forme d'image, de son, de texte et de couleurs.</p>
        </section>
        
        <!-- Zone de génération -->
        <section class="generator">
            <div class="prompt-container">
                <textarea class="prompt-input" id="promptInput" placeholder="Exemple: Un chat japonais qui mange des nouilles, style manga..."></textarea>
                
                <div class="examples">
                    <div class="example-tag" data-prompt="Un chat japonais qui mange des nouilles, style manga">Chat mangeur de nouilles</div>
                    <div class="example-tag" data-prompt="Un vieux robot jardinant sur Mars, aquarelle">Robot jardinier martien</div>
                    <div class="example-tag" data-prompt="Une librairie flottante dans les nuages, estampe">Librairie flottante</div>
                    <div class="example-tag" data-prompt="Un samouraï dans une station spatiale, croquis">Samouraï spatial</div>
                </div>
            </div>
            
            <button class="generate-btn" id="generateBtn">
                <i class="fas fa-magic btn-icon"></i> Créer l'univers
            </button>
            
            <!-- Loader -->
            <div class="loader" id="loader">
                <div class="alchemy-loader"></div>
                <p>Création de votre univers en cours... Cette opération peut prendre quelques secondes.</p>
            </div>
            
            <!-- Messages -->
            <div class="message" id="message"></div>
        </section>
        
        <!-- Résultats -->
        <section class="results" id="resultsSection">
            <div class="results-grid">
                <!-- Colonne gauche : Image et couleurs -->
                <div>
                    <!-- Image générée -->
                    <div class="result-card">
                        <h3 class="card-title">
                            <i class="fas fa-image"></i> L'Univers Visuel
                        </h3>
                        <div class="image-container">
                            <div class="placeholder-image" id="imagePlaceholder">
                                <i class="fas fa-mountain-sun"></i>
                                <p>Votre image apparaîtra ici</p>
                            </div>
                            <canvas id="generatedCanvas" width="800" height="500" style="display: none; border-radius: 12px;"></canvas>
                            <img class="generated-image" id="generatedImage" alt="Univers généré">
                        </div>
                    </div>
                    
                    <!-- Palette de couleurs -->
                    <div class="result-card">
                        <h3 class="card-title">
                            <i class="fas fa-palette"></i> Palette de Couleurs
                        </h3>
                        <div class="color-palette" id="colorPalette">
                            <div class="placeholder-image">
                                <i class="fas fa-fill-drip"></i>
                                <p>Les couleurs extraites de l'image apparaîtront ici</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Colonne droite : Son et texte -->
                <div>
                    <!-- Ambiance sonore -->
                    <div class="result-card">
                        <h3 class="card-title">
                            <i class="fas fa-music"></i> Ambiance Sonore
                        </h3>
                        <div class="audio-container">
                            <div class="audio-visualizer">
                                <canvas id="audioCanvas"></canvas>
                            </div>
                            <div class="audio-controls">
                                <button class="audio-btn" id="playBtn">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="audio-btn" id="stopBtn" disabled>
                                    <i class="fas fa-stop"></i>
                                </button>
                                <div class="audio-info" id="audioInfo">
                                    Ambiance générée à partir de votre description
                                </div>
                                <a class="audio-download" id="audioDownload" download="ambiance-univers.mp3">
                                    <i class="fas fa-download"></i> Télécharger
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Texte poétique -->
                    <div class="result-card">
                        <h3 class="card-title">
                            <i class="fas fa-feather-alt"></i> Évocation Poétique
                        </h3>
                        <div class="text-container">
                            <div class="text-placeholder" id="textPlaceholder">
                                <i class="fas fa-book-open"></i>
                                <p>La description poétique de votre univers apparaîtra ici</p>
                            </div>
                            <div class="generated-text" id="generatedText"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="actions">
                <button class="action-btn" id="shareBtn">
                    <i class="fas fa-share-alt"></i> Partager cet univers
                </button>
                <button class="action-btn" id="downloadAllBtn">
                    <i class="fas fa-file-archive"></i> Tout télécharger (ZIP)
                </button>
                <button class="action-btn" id="regenerateBtn">
                    <i class="fas fa-redo"></i> Recréer un autre univers
                </button>
            </div>
        </section>
        
        <!-- Footer -->
        <footer>
            <p>Univers à Mots - Générateur d'Univers Immersifs</p>
            <div class="footer-links">
                <a href="#" class="footer-link" id="aboutLink">
                    <i class="fas fa-info-circle"></i> À propos
                </a>
            </div>
            <p>© 2023 - Créé avec <i class="fas fa-heart" style="color: #ef4444;"></i> sans backend ni API keys</p>
        </footer>
    </div>

    <script>
        // ============ ÉTAT DE L'APPLICATION ============
        const appState = {
            currentTheme: 'dark',
            isGenerating: false,
            currentAudio: null,
            isPlaying: false,
            audioContext: null,
            currentColors: [],
            currentImageUrl: '',
            currentText: '',
            currentPrompt: '',
            visualizerInterval: null,
            audioAnalyser: null,
            audioSource: null
        };
        
        // ============ RÉFÉRENCES DOM ============
        const themeToggle = document.getElementById('themeToggle');
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const loader = document.getElementById('loader');
        const message = document.getElementById('message');
        const resultsSection = document.getElementById('resultsSection');
        const generatedImage = document.getElementById('generatedImage');
        const generatedCanvas = document.getElementById('generatedCanvas');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const colorPalette = document.getElementById('colorPalette');
        const audioCanvas = document.getElementById('audioCanvas');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const audioInfo = document.getElementById('audioInfo');
        const audioDownload = document.getElementById('audioDownload');
        const generatedText = document.getElementById('generatedText');
        const textPlaceholder = document.getElementById('textPlaceholder');
        const shareBtn = document.getElementById('shareBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const exampleTags = document.querySelectorAll('.example-tag');
        const aboutLink = document.getElementById('aboutLink');
        
        // ============ BASE DE DONNÉES DE CONTENU ============
        // Images générées par prompt avec Canvas
        const imageTemplates = {
            // Template pour "chat japonais qui mange des nouilles"
            "chat": {
                elements: [
                    { type: 'circle', x: 400, y: 250, radius: 120, color: '#FFD700', label: 'Tête de chat' },
                    { type: 'triangle', points: [[350, 180], [450, 180], [400, 130]], color: '#FFB6C1', label: 'Oreilles' },
                    { type: 'ellipse', x: 400, y: 380, rx: 150, ry: 60, color: '#87CEEB', label: 'Bol de nouilles' },
                    { type: 'line', points: [[400, 250], [400, 320]], color: '#000000', label: 'Corps' }
                ],
                background: '#FFF5E1',
                title: "Chat Mangeur de Nouilles",
                style: "Manga japonais"
            },
            
            // Template pour "robot jardinier martien"
            "robot": {
                elements: [
                    { type: 'rect', x: 350, y: 150, width: 100, height: 120, color: '#A9A9A9', label: 'Tête robot' },
                    { type: 'circle', x: 400, y: 300, radius: 80, color: '#708090', label: 'Corps' },
                    { type: 'rect', x: 300, y: 380, width: 200, height: 20, color: '#8B4513', label: 'Plateforme' },
                    { type: 'circle', x: 320, y: 400, radius: 30, color: '#2F4F4F', label: 'Roue' },
                    { type: 'circle', x: 480, y: 400, radius: 30, color: '#2F4F4F', label: 'Roue' },
                    { type: 'circle', x: 400, y: 200, radius: 20, color: '#FF4500', label: 'Œil' }
                ],
                background: '#FFE4C4',
                title: "Robot Jardinier Martien",
                style: "Aquarelle martienne"
            },
            
            // Template pour "librairie flottante"
            "librairie": {
                elements: [
                    { type: 'rect', x: 300, y: 200, width: 200, height: 150, color: '#DEB887', label: 'Bâtiment' },
                    { type: 'triangle', points: [[300, 200], [500, 200], [400, 100]], color: '#8B4513', label: 'Toit' },
                    { type: 'rect', x: 310, y: 210, width: 180, height: 130, color: '#F5F5DC', label: 'Intérieur' },
                    { type: 'circle', x: 400, y: 100, radius: 20, color: '#FFD700', label: 'Étoile' },
                    { type: 'cloud', x: 200, y: 100, size: 40, color: '#FFFFFF', label: 'Nuage' },
                    { type: 'cloud', x: 550, y: 150, size: 50, color: '#FFFFFF', label: 'Nuage' }
                ],
                background: '#87CEEB',
                title: "Librairie Flottante",
                style: "Estampe japonaise"
            },
            
            // Template pour "samouraï spatial"
            "samouraï": {
                elements: [
                    { type: 'rect', x: 350, y: 200, width: 100, height: 200, color: '#2F4F4F', label: 'Armure' },
                    { type: 'circle', x: 400, y: 150, radius: 50, color: '#696969', label: 'Casque' },
                    { type: 'line', points: [[400, 150], [400, 100]], color: '#000000', label: 'Plume' },
                    { type: 'line', points: [[300, 250], [500, 250]], color: '#8B0000', label: 'Épée' },
                    { type: 'circle', x: 600, y: 100, radius: 30, color: '#FFD700', label: 'Planète' },
                    { type: 'circle', x: 200, y: 150, radius: 20, color: '#1E90FF', label: 'Étoile' }
                ],
                background: '#0F0F1A',
                title: "Samouraï Spatial",
                style: "Croquis au crayon"
            }
        };
        
        // Textes poétiques adaptés
        const poeticTexts = {
            "chat": "Un petit chat du Japon, assis devant son bol de ramen fumant. Ses yeux mi-clos trahissent un bonheur simple, tandis que ses moustaches frémissent au rythme des baguettes. Dans ce moment de pure gourmandise, le temps semble suspendu entre tradition et délice.",
            
            "robot": "Sur le sol rouge de Mars, un vieux robot cultive avec patience un jardin extraterrestre. Ses gestes mécaniques, empreints d'une tendresse surprenante, caressent des pousses aux couleurs jamais vues sur Terre. Dans le silence de la planète rouge, c'est un acte d'espoir, une affirmation de vie au milieu de l'immensité stérile.",
            
            "librairie": "Flottant doucement parmi les nuages, cette librairie céleste défie les lois de la gravité. Les livres y volent littéralement des étagères, leurs pages tournant au gré des courants aériens. Ici, la lecture est une expérience aérienne, où chaque histoire prend son envol avec les nuages.",
            
            "samouraï": "Dans le silence métallique d'une station spatiale abandonnée, un samouraï médite. Son armure traditionnelle contraste étrangement avec les écrans holographiques défectueux. Entre honneur ancestral et futur déchu, il garde un poste que l'humanité a oublié, sentinelle entre deux mondes, deux époques."
        };
        
        // Ambiances sonores (descriptions)
        const audioDescriptions = {
            "chat": "Ambiance japonaise douce avec bruits de baguettes et ronronnements",
            "robot": "Sons mécaniques doux et bourdonnements électroniques martiens",
            "librairie": "Bruits de pages tournées et murmures légers dans les nuages",
            "samouraï": "Silence spatial ponctué de sons de métal et respiration calme"
        };
        
        // Palettes de couleurs par thème
        const colorPalettes = {
            "chat": ['#FFD700', '#FFB6C1', '#87CEEB', '#FFF5E1', '#FFA07A'],
            "robot": ['#A9A9A9', '#708090', '#8B4513', '#2F4F4F', '#FF4500'],
            "librairie": ['#DEB887', '#8B4513', '#F5F5DC', '#87CEEB', '#FFFFFF'],
            "samouraï": ['#2F4F4F', '#696969', '#8B0000', '#0F0F1A', '#FFD700']
        };
        
        // ============ INITIALISATION ============
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            initEventListeners();
            setTheme(appState.currentTheme);
            initAudioVisualizer();
            
            // Lien À propos
            aboutLink.addEventListener('click', function(e) {
                e.preventDefault();
                showMessage("Univers à Mots génère des univers à partir de vos descriptions sans aucune API externe. Tout est créé directement dans votre navigateur !", "info");
            });
            
            // Démo au chargement
            setTimeout(() => {
                showMessage("Prêt à créer ! Cliquez sur un exemple ou écrivez votre propre description.", "success");
            }, 1000);
        });
        
        // ============ ÉCOUTEURS D'ÉVÉNEMENTS ============
        function initEventListeners() {
            // Thème
            themeToggle.addEventListener('click', toggleTheme);
            
            // Bouton de génération
            generateBtn.addEventListener('click', generateUniverse);
            
            // Exemples
            exampleTags.forEach(tag => {
                tag.addEventListener('click', function() {
                    promptInput.value = this.getAttribute('data-prompt');
                    promptInput.focus();
                });
            });
            
            // Contrôles audio
            playBtn.addEventListener('click', toggleAudio);
            stopBtn.addEventListener('click', stopAudio);
            
            // Actions
            shareBtn.addEventListener('click', shareUniverse);
            downloadAllBtn.addEventListener('click', downloadAll);
            regenerateBtn.addEventListener('click', regenerateUniverse);
            
            // Entrée dans le textarea
            promptInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    generateUniverse();
                }
            });
        }
        
        // ============ GESTION DU THÈME ============
        function toggleTheme() {
            const newTheme = appState.currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        function setTheme(theme) {
            appState.currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            
            localStorage.setItem('univers-a-mots-theme', theme);
        }
        
        // ============ PARTICULES DE FOND ============
        function initParticles() {
            const canvas = document.getElementById('particles-canvas');
            const ctx = canvas.getContext('2d');
            
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            const particles = [];
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 3 + 1,
                    speedX: Math.random() * 0.5 - 0.25,
                    speedY: Math.random() * 0.5 - 0.25,
                    color: `rgba(${Math.floor(Math.random() * 100 + 155)}, ${Math.floor(Math.random() * 100 + 100)}, ${Math.floor(Math.random() * 155 + 100)}, ${Math.random() * 0.3 + 0.1})`
                });
            }
            
            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;
                    
                    if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
                    
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    
                    particles.forEach(p2 => {
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 100) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(124, 58, 237, ${0.1 * (1 - distance/100)})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    });
                });
                
                requestAnimationFrame(animateParticles);
            }
            
            animateParticles();
        }
        
        // ============ GÉNÉRATION DE L'UNIVERS ============
        async function generateUniverse() {
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                showMessage("Veuillez décrire un univers avant de créer.", "warning");
                promptInput.focus();
                return;
            }
            
            if (appState.isGenerating) {
                showMessage("Génération déjà en cours. Veuillez patienter.", "warning");
                return;
            }
            
            appState.isGenerating = true;
            appState.currentPrompt = prompt;
            
            // Réinitialiser
            stopAudio();
            resetResults();
            
            // Afficher le loader
            loader.classList.add('active');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Création en cours...';
            
            showMessage("Création de votre univers...", "info");
            
            try {
                // Détecter le type de prompt
                const promptType = detectPromptType(prompt);
                
                // Générer les éléments
                await generateImageWithCanvas(promptType);
                await generateTextContent(promptType);
                await generateAudioContent(promptType);
                await generateColorPalette(promptType);
                
                // Afficher les résultats
                setTimeout(() => {
                    loader.classList.remove('active');
                    resultsSection.classList.add('active');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-magic btn-icon"></i> Créer l\'univers';
                    appState.isGenerating = false;
                    
                    showMessage(`Votre univers "${promptType}" a été créé avec succès !`, "success");
                    
                }, 1500);
                
            } catch (error) {
                console.error("Erreur:", error);
                showMessage("Utilisation du mode démo...", "warning");
                
                useDemoMode(prompt);
                
                loader.classList.remove('active');
                resultsSection.classList.add('active');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic btn-icon"></i> Créer l\'univers';
                appState.isGenerating = false;
            }
        }
        
        // ============ DÉTECTION DU TYPE DE PROMPT ============
        function detectPromptType(prompt) {
            const promptLower = prompt.toLowerCase();
            
            if (promptLower.includes('chat') || promptLower.includes('félin') || promptLower.includes('japonais') || promptLower.includes('nouille')) {
                return 'chat';
            } else if (promptLower.includes('robot') || promptLower.includes('martien') || promptLower.includes('mars') || promptLower.includes('jardin')) {
                return 'robot';
            } else if (promptLower.includes('librairie') || promptLower.includes('livre') || promptLower.includes('bibliothèque') || promptLower.includes('flottant')) {
                return 'librairie';
            } else if (promptLower.includes('samouraï') || promptLower.includes('guerrier') || promptLower.includes('épée') || promptLower.includes('spatial')) {
                return 'samouraï';
            }
            
            // Si aucun match, retourner un type aléatoire
            const types = ['chat', 'robot', 'librairie', 'samouraï'];
            return types[Math.floor(Math.random() * types.length)];
        }
        
        // ============ GÉNÉRATION D'IMAGE AVEC CANVAS ============
        function generateImageWithCanvas(promptType) {
            showMessage("Création de l'image...", "info");
            
            const template = imageTemplates[promptType] || imageTemplates.chat;
            const ctx = generatedCanvas.getContext('2d');
            
            // Afficher le canvas et cacher le placeholder
            generatedCanvas.style.display = 'block';
            imagePlaceholder.style.display = 'none';
            
            // Nettoyer le canvas
            ctx.clearRect(0, 0, generatedCanvas.width, generatedCanvas.height);
            
            // Fond
            ctx.fillStyle = template.background;
            ctx.fillRect(0, 0, generatedCanvas.width, generatedCanvas.height);
            
            // Dessiner les éléments
            template.elements.forEach(element => {
                ctx.fillStyle = element.color;
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                
                switch(element.type) {
                    case 'circle':
                        ctx.beginPath();
                        ctx.arc(element.x, element.y, element.radius, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        break;
                        
                    case 'rect':
                        ctx.fillRect(element.x, element.y, element.width, element.height);
                        ctx.strokeRect(element.x, element.y, element.width, element.height);
                        break;
                        
                    case 'triangle':
                        ctx.beginPath();
                        ctx.moveTo(element.points[0][0], element.points[0][1]);
                        ctx.lineTo(element.points[1][0], element.points[1][1]);
                        ctx.lineTo(element.points[2][0], element.points[2][1]);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        break;
                        
                    case 'ellipse':
                        ctx.beginPath();
                        ctx.ellipse(element.x, element.y, element.rx, element.ry, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        break;
                        
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(element.points[0][0], element.points[0][1]);
                        ctx.lineTo(element.points[1][0], element.points[1][1]);
                        ctx.stroke();
                        break;
                        
                    case 'cloud':
                        // Dessiner un nuage simple
                        ctx.beginPath();
                        ctx.arc(element.x, element.y, element.size, 0, Math.PI * 2);
                        ctx.arc(element.x + element.size * 0.7, element.y - element.size * 0.3, element.size * 0.8, 0, Math.PI * 2);
                        ctx.arc(element.x + element.size * 1.4, element.y, element.size, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                }
            });
            
            // Ajouter un titre
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(template.title, 400, 50);
            
            ctx.font = 'italic 18px Arial';
            ctx.fillText(`Style: ${template.style}`, 400, 80);
            
            // Convertir le canvas en URL d'image
            appState.currentImageUrl = generatedCanvas.toDataURL('image/png');
            generatedImage.src = appState.currentImageUrl;
            generatedImage.classList.add('active');
            
            return new Promise(resolve => setTimeout(resolve, 800));
        }
        
        // ============ GÉNÉRATION DE TEXTE ============
        function generateTextContent(promptType) {
            showMessage("Écriture de l'évocation poétique...", "info");
            
            const text = poeticTexts[promptType] || poeticTexts.chat;
            appState.currentText = text;
            
            textPlaceholder.style.display = 'none';
            generatedText.textContent = text;
            generatedText.classList.add('active');
            
            return new Promise(resolve => setTimeout(resolve, 600));
        }
        
        // ============ GÉNÉRATION AUDIO (VRAIMENT FONCTIONNEL) ============
        function generateAudioContent(promptType) {
            showMessage("Création de l'ambiance sonore...", "info");
            
            const description = audioDescriptions[promptType] || audioDescriptions.chat;
            audioInfo.textContent = description;
            
            // Initialiser l'audio
            initAudioSystem(promptType);
            
            // Activer le bouton de téléchargement
            audioDownload.href = "#";
            audioDownload.onclick = function(e) {
                e.preventDefault();
                downloadAudioFile(promptType);
            };
            
            return new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // ============ SYSTÈME AUDIO ============
        function initAudioSystem(promptType) {
            // Arrêter l'audio existant
            if (appState.audioContext) {
                appState.audioContext.close();
            }
            
            // Créer un nouveau contexte audio
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            appState.audioContext = new AudioContext();
            
            // Créer les nœuds audio
            const oscillator1 = appState.audioContext.createOscillator();
            const oscillator2 = appState.audioContext.createOscillator();
            const gainNode = appState.audioContext.createGain();
            const filter = appState.audioContext.createBiquadFilter();
            
            // Configurer selon le type
            let freq1, freq2, wave1, wave2;
            
            switch(promptType) {
                case 'chat':
                    freq1 = 330; freq2 = 660;
                    wave1 = 'sine'; wave2 = 'sine';
                    break;
                case 'robot':
                    freq1 = 110; freq2 = 220;
                    wave1 = 'sawtooth'; wave2 = 'square';
                    break;
                case 'librairie':
                    freq1 = 220; freq2 = 440;
                    wave1 = 'sine'; wave2 = 'triangle';
                    break;
                case 'samouraï':
                    freq1 = 147; freq2 = 294;
                    wave1 = 'sawtooth'; wave2 = 'sine';
                    break;
                default:
                    freq1 = 220; freq2 = 440;
                    wave1 = 'sine'; wave2 = 'triangle';
            }
            
            oscillator1.type = wave1;
            oscillator1.frequency.setValueAtTime(freq1, appState.audioContext.currentTime);
            
            oscillator2.type = wave2;
            oscillator2.frequency.setValueAtTime(freq2, appState.audioContext.currentTime);
            
            // Configurer le filtre
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1000, appState.audioContext.currentTime);
            
            // Configurer le volume
            gainNode.gain.setValueAtTime(0.1, appState.audioContext.currentTime);
            
            // Connexions
            oscillator1.connect(filter);
            oscillator2.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(appState.audioContext.destination);
            
            // Démarrer les oscillateurs
            oscillator1.start();
            oscillator2.start();
            
            // Mettre en pause initialement
            appState.audioContext.suspend();
            
            // Stocker les références
            appState.currentAudio = {
                oscillator1, oscillator2, gainNode, filter,
                isPlaying: false
            };
            
            // Mettre à jour l'interface
            playBtn.disabled = false;
            stopBtn.disabled = true;
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            appState.isPlaying = false;
            
            // Mettre à jour le visualiseur
            updateAudioVisualizer();
        }
        
        // ============ VISUALISEUR AUDIO ============
        function initAudioVisualizer() {
            const canvas = audioCanvas;
            const ctx = canvas.getContext('2d');
            
            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function updateAudioVisualizer() {
            const canvas = audioCanvas;
            const ctx = canvas.getContext('2d');
            
            // Nettoyer l'intervalle précédent
            if (appState.visualizerInterval) {
                clearInterval(appState.visualizerInterval);
            }
            
            // Animer le visualiseur
            appState.visualizerInterval = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Fond
                ctx.fillStyle = appState.currentTheme === 'dark' ? 'rgba(26, 26, 46, 0.7)' : 'rgba(233, 236, 239, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Barres du visualiseur
                const barCount = 32;
                const barWidth = canvas.width / barCount;
                const isPlaying = appState.isPlaying;
                
                for (let i = 0; i < barCount; i++) {
                    let barHeight;
                    if (isPlaying) {
                        const time = Date.now() / 200;
                        const noise = Math.sin(time + i * 0.3) * 0.5 + 0.5;
                        barHeight = noise * (canvas.height * 0.7) + (canvas.height * 0.1);
                    } else {
                        const time = Date.now() / 1000;
                        const wave = Math.sin(time + i * 0.2) * 0.3 + 0.5;
                        barHeight = wave * (canvas.height * 0.3) + (canvas.height * 0.2);
                    }
                    
                    const x = i * barWidth;
                    const y = canvas.height - barHeight;
                    
                    // Dégradé
                    const gradient = ctx.createLinearGradient(0, y, 0, canvas.height);
                    const hue = (i * 10 + Date.now() / 50) % 360;
                    gradient.addColorStop(0, `hsla(${hue}, 80%, 60%, 0.9)`);
                    gradient.addColorStop(1, `hsla(${(hue + 60) % 360}, 80%, 40%, 0.4)`);
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x + 1, y, barWidth - 2, barHeight);
                    
                    // Effet de brillance
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(x + 1, y, barWidth - 2, 3);
                }
            }, 50);
        }
        
        // ============ CONTRÔLES AUDIO ============
        function toggleAudio() {
            if (!appState.audioContext || !appState.currentAudio) return;
            
            if (appState.isPlaying) {
                // Pause
                appState.audioContext.suspend();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                stopBtn.disabled = false;
                appState.isPlaying = false;
            } else {
                // Play
                appState.audioContext.resume();
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                stopBtn.disabled = false;
                appState.isPlaying = true;
            }
        }
        
        function stopAudio() {
            if (!appState.currentAudio) return;
            
            // Recréer le système audio
            const promptType = detectPromptType(appState.currentPrompt);
            initAudioSystem(promptType);
        }
        
        // ============ GÉNÉRATION DE PALETTE DE COULEURS ============
        function generateColorPalette(promptType) {
            showMessage("Extraction des couleurs...", "info");
            
            const colors = colorPalettes[promptType] || colorPalettes.chat;
            appState.currentColors = colors.map(hex => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return [r, g, b];
            });
            
            // Afficher la palette
            displayColorPalette(appState.currentColors);
            
            return new Promise(resolve => setTimeout(resolve, 400));
        }
        
        function displayColorPalette(colors) {
            colorPalette.innerHTML = '';
            
            colors.forEach(color => {
                const hex = rgbToHex(color[0], color[1], color[2]);
                
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = hex;
                swatch.title = hex;
                
                const hexCode = document.createElement('div');
                hexCode.className = 'color-hex';
                hexCode.textContent = hex;
                hexCode.title = "Cliquer pour copier";
                
                hexCode.addEventListener('click', function() {
                    navigator.clipboard.writeText(hex).then(() => {
                        showMessage(`Couleur ${hex} copiée !`, "success");
                    });
                });
                
                colorItem.appendChild(swatch);
                colorItem.appendChild(hexCode);
                colorPalette.appendChild(colorItem);
            });
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }
        
        // ============ TÉLÉCHARGEMENT AUDIO ============
        function downloadAudioFile(promptType) {
            showMessage("Préparation du fichier audio...", "info");
            
            // Créer un fichier texte avec les instructions (puisqu'on ne peut pas générer de vrai MP3 sans API)
            const audioContent = `Ambiance sonore générée pour: "${appState.currentPrompt}"
            
Type: ${promptType}
Description: ${audioDescriptions[promptType]}

Paramètres de synthèse:
- Fréquence 1: ${promptType === 'chat' ? '330Hz' : promptType === 'robot' ? '110Hz' : '220Hz'}
- Fréquence 2: ${promptType === 'chat' ? '660Hz' : promptType === 'robot' ? '220Hz' : '440Hz'}
- Forme d'onde: Sinus et triangle
- Filtre: Lowpass à 1000Hz

Pour recréer cette ambiance:
1. Ouvrez un synthétiseur en ligne
2. Réglez deux oscillateurs avec les paramètres ci-dessus
3. Ajoutez un filtre lowpass
4. Jouez pour entendre une ambiance similaire

Date de génération: ${new Date().toLocaleString()}`;
            
            const blob = new Blob([audioContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ambiance-${promptType}-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                showMessage("Fichier audio téléchargé !", "success");
            }, 500);
        }
        
        // ============ PARTAGE ============
        function shareUniverse() {
            showMessage("Capture de l'univers...", "info");
            
            // Capturer la section des résultats
            html2canvas(resultsSection).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.share && navigator.canShare) {
                        const file = new File([blob], 'univers-a-mots.png', { type: 'image/png' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            navigator.share({
                                files: [file],
                                title: 'Mon univers créé avec Univers à Mots',
                                text: `J'ai créé cet univers: "${appState.currentPrompt}"`
                            }).then(() => {
                                showMessage("Univers partagé avec succès !", "success");
                            }).catch(error => {
                                console.error('Erreur de partage:', error);
                                fallbackShare(canvas);
                            });
                        } else {
                            fallbackShare(canvas);
                        }
                    } else {
                        fallbackShare(canvas);
                    }
                });
            }).catch(error => {
                console.error("Erreur de capture:", error);
                showMessage("Impossible de partager. Essayez le téléchargement.", "error");
            });
        }
        
        function fallbackShare(canvas) {
            const link = document.createElement('a');
            link.download = `univers-a-mots-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showMessage("Image téléchargée. Vous pouvez la partager manuellement.", "success");
        }
        
        // ============ TÉLÉCHARGER TOUT ============
        function downloadAll() {
            showMessage("Création de l'archive...", "info");
            
            const zip = new JSZip();
            
            // Ajouter l'image (depuis le canvas)
            const imageData = generatedCanvas.toDataURL('image/png').split(',')[1];
            zip.file("univers-image.png", imageData, { base64: true });
            
            // Ajouter le texte
            zip.file("univers-description.txt", `Univers créé avec "Univers à Mots"
            
Prompt: "${appState.currentPrompt}"

Description poétique:
${appState.currentText}

Palette de couleurs:
${appState.currentColors.map(color => rgbToHex(color[0], color[1], color[2])).join(', ')}

Date de création: ${new Date().toLocaleString()}`);
            
            // Ajouter les métadonnées
            const metadata = {
                prompt: appState.currentPrompt,
                colors: appState.currentColors.map(color => rgbToHex(color[0], color[1], color[2])),
                text: appState.currentText,
                date: new Date().toISOString(),
                type: detectPromptType(appState.currentPrompt)
            };
            
            zip.file("metadata.json", JSON.stringify(metadata, null, 2));
            
            // Générer et télécharger le ZIP
            zip.generateAsync({ type: "blob" })
                .then(content => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `univers-a-mots-${Date.now()}.zip`;
                    link.click();
                    
                    showMessage("Archive téléchargée avec succès !", "success");
                })
                .catch(error => {
                    console.error("Erreur lors de la création de l'archive:", error);
                    showMessage("Erreur lors de la création de l'archive", "error");
                });
        }
        
        // ============ RECRÉER ============
        function regenerateUniverse() {
            promptInput.value = '';
            promptInput.focus();
            
            resultsSection.classList.remove('active');
            resetResults();
            
            showMessage("Prêt pour une nouvelle création !", "success");
        }
        
        // ============ RÉINITIALISATION ============
        function resetResults() {
            // Image
            generatedImage.classList.remove('active');
            generatedImage.src = '';
            generatedCanvas.style.display = 'none';
            imagePlaceholder.style.display = 'flex';
            
            // Couleurs
            colorPalette.innerHTML = '<div class="placeholder-image"><i class="fas fa-fill-drip"></i><p>Les couleurs extraites de l\'image apparaîtront ici</p></div>';
            
            // Audio
            stopAudio();
            audioInfo.textContent = "Ambiance générée à partir de votre description";
            audioDownload.href = "#";
            audioDownload.onclick = null;
            
            // Texte
            generatedText.classList.remove('active');
            generatedText.textContent = '';
            textPlaceholder.style.display = 'flex';
            
            // Visualiseur
            if (appState.visualizerInterval) {
                clearInterval(appState.visualizerInterval);
                appState.visualizerInterval = null;
            }
        }
        
        // ============ MODE DÉMO ============
        function useDemoMode(prompt) {
            const promptType = detectPromptType(prompt) || 'chat';
            
            // Générer l'image
            generateImageWithCanvas(promptType);
            
            // Générer le texte
            const text = poeticTexts[promptType] || poeticTexts.chat;
            appState.currentText = text;
            textPlaceholder.style.display = 'none';
            generatedText.textContent = text;
            generatedText.classList.add('active');
            
            // Générer l'audio
            const description = audioDescriptions[promptType] || audioDescriptions.chat;
            audioInfo.textContent = description;
            initAudioSystem(promptType);
            
            // Générer les couleurs
            generateColorPalette(promptType);
        }
        
        // ============ MESSAGES ============
        function showMessage(text, type) {
            message.textContent = text;
            message.className = `message ${type} active`;
            
            setTimeout(() => {
                message.classList.remove('active');
            }, 5000);
        }
    </script>
</body>
</html>
